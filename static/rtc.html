<button onclick="start()">Start</button>
<div id="log"></div>

<script>

    let conn, pc, localSession;

    log = msg => {
        document.getElementById("log").innerHTML += `<p>${msg}</p>`;
        console.log(msg);
    }

    WebSocket.prototype.send2 = function(id, data) {
        if (data == undefined) {
            data = "";
        }
        this.send(JSON.stringify({"id": id, "data": data}));
    }

    conn = new WebSocket(`ws://${location.host}/ws`);

    conn.onopen = () => { 
        log("WebSocket is opened"); 
    }

    conn.onerror = error => { log(`Websocket error: ${error}`); }

    conn.onclose = () => {
        log("Websocket closed");
    }

    conn.onmessage = e => {
        log(`Recv: ${e.data}`);
        d = JSON.parse(e.data);
        switch (d["id"]) {
            case "error":
                log(`[!] Error from server: ${d["data"]}`);
                break;

            case "sdp":
                log("Got remote sdp");
                pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(d["data"]))));
                break;
        }
    }


    pc = new RTCPeerConnection({ iceServers: [{ urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302'] }] });

    pc.oniceconnectionstatechange = e => {
        log(`iceConnectionState: ${pc.iceConnectionState}`);

        if (pc.iceConnectionState === "connected") {
            gameReady = true
            iceSuccess = true
            //conn.send(JSON.stringify({"id": "start", "data": ""}));
        }
        else if (pc.iceConnectionState === "failed") {
            gameReady = false
            iceSuccess = false
        }
        else if (pc.iceConnectionState === "disconnected") {
            stopInputTimer();
        }
    }

    
    // candidate packet from STUN
    pc.onicecandidate = event => {
        if (event.candidate === null) {
            // // send to ws
            // session = btoa(JSON.stringify(pc.localDescription));
            // localSessionDescription = session;
            // log("Send SDP to remote peer");
            // // TODO: Fix curPacketID
            // conn.send(JSON.stringify({"id": "initwebrtc", "data": session, "packet_id": curPacketID}));
        } else {
            // conn.send(JSON.stringify({"id": "icecandidate", "data": JSON.stringify(event.candidate)}));
            // log(JSON.stringify(event.candidate));
        }
    }

    // create SDP
    pc.createOffer({offerToReceiveVideo: true, offerToReceiveAudio: false}).then(d => {
        localSession = btoa(JSON.stringify(d));
        pc.setLocalDescription(d).catch(log);
    });

    
    //start

    function start() {
        if (localSession) {
            conn.send2("sdp", localSession);
        } else {
            log("No local sdp");
        }
    }



</script>